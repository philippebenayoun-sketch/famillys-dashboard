<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bilan Commercial Famillys ‚Äì 2022 √† 2026</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Source+Sans+3:wght@400;600;700&display=swap');
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --gold: #c8a96e; --dark: #2c1a0e; --bg: #faf7f2; --card: #ffffff;
    --border: #e8dfc8; --muted: #8b7355; --green: #1a5c3a; --light-bg: #faf5ec;
  }
  body { background:var(--bg); font-family:'Source Sans 3','Segoe UI',sans-serif; color:var(--dark); padding:36px 24px; max-width:1080px; margin:0 auto; }

  .header { display:flex; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; gap:16px; padding-bottom:22px; border-bottom:2px solid var(--gold); margin-bottom:28px; }
  .eyebrow { font-size:11px; font-weight:700; letter-spacing:3px; text-transform:uppercase; color:var(--gold); margin-bottom:6px; }
  h1 { font-family:'Playfair Display',Georgia,serif; font-size:28px; line-height:1.2; }
  h1 span { color:var(--gold); }
  .print-date { font-size:12px; color:var(--muted); margin-top:6px; }

  .tabs-wrap { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px; margin-bottom:24px; }
  .tabs { display:flex; gap:3px; background:#ede8df; border-radius:10px; padding:4px; flex-wrap:wrap; }
  .tab { background:transparent; border:none; border-radius:7px; color:var(--muted); padding:7px 16px; font-size:13px; font-weight:700; cursor:pointer; transition:all 0.18s; font-family:inherit; white-space:nowrap; }
  .tab.active { background:var(--dark); color:#faf7f2; }
  .tab.tw.active { background:#0d9488; color:white; }
  .print-btn { background:var(--gold); color:white; border:none; border-radius:8px; padding:8px 18px; font-size:13px; font-weight:700; cursor:pointer; font-family:inherit; }

  .kpis { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-bottom:24px; }
  .kpi { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px 18px; box-shadow:0 2px 8px rgba(0,0,0,0.04); }
  .kpi-label { font-size:10px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--muted); margin-bottom:6px; }
  .kpi-value { font-size:20px; font-weight:700; }
  .kpi-sub { font-size:11px; color:#b0956e; margin-top:3px; }

  .charts-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:20px; }
  .chart-card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:18px; box-shadow:0 2px 8px rgba(0,0,0,0.04); }
  .chart-card h3 { font-size:10px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--muted); margin-bottom:12px; }
  .chart-wrap { position:relative; height:200px; }
  .chart-full { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:18px; box-shadow:0 2px 8px rgba(0,0,0,0.04); margin-bottom:20px; }
  .chart-full h3 { font-size:10px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--muted); margin-bottom:12px; }

  .table-card { background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.04); margin-bottom:20px; }
  .table-head-bar { background:var(--dark); padding:12px 18px; color:white; font-size:13px; font-weight:700; display:flex; justify-content:space-between; align-items:center; }
  .sub { font-size:11px; font-weight:400; opacity:.7; }
  table { width:100%; border-collapse:collapse; }
  thead tr { background:var(--light-bg); }
  th { padding:9px 14px; font-size:10px; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--muted); border-bottom:2px solid var(--border); }
  th.r { text-align:right; } th.c { text-align:center; }
  td { padding:9px 14px; border-bottom:1px solid #f0e8d8; font-size:13px; }
  tbody tr:last-child td { border-bottom:none; }
  tbody tr:hover { background:#fdf9f3; }
  td.r { text-align:right; } td.c { text-align:center; }
  tfoot tr { background:var(--light-bg); border-top:2px solid var(--gold); }
  tfoot td { padding:11px 14px; font-weight:700; font-size:13px; }

  .week-last { background:#eff6ff !important; }
  .trend-up { color:#16a34a; font-weight:700; }
  .trend-down { color:#dc2626; font-weight:700; }
  .trend-eq { color:var(--muted); }

  .legend { display:flex; gap:16px; justify-content:center; margin-top:10px; flex-wrap:wrap; }
  .legend-item { display:flex; align-items:center; gap:6px; font-size:12px; color:var(--muted); }
  .ldot { width:12px; height:12px; border-radius:3px; flex-shrink:0; }

  .badge { display:inline-block; border-radius:20px; padding:2px 9px; font-size:12px; font-weight:700; background:var(--dark); color:white; }
  .tag { display:inline-block; border-radius:4px; padding:1px 7px; font-size:11px; font-weight:600; margin:0 2px; }
  .t349 { background:#d1fae5; color:#065f46; }
  .t99  { background:#ede9fe; color:#5b21b6; }
  .t79  { background:#fce7f3; color:#9d174d; }

  .note { background:#fffbf0; border:1px solid var(--border); border-radius:10px; padding:12px 16px; font-size:12px; color:var(--muted); line-height:1.6; }

  @media print {
    body { padding:16px; background:white; }
    .no-print { display:none !important; }
    .kpis { grid-template-columns:repeat(4,1fr); }
    * { print-color-adjust:exact; -webkit-print-color-adjust:exact; }
  }
</style>
</head>
<body>

<div class="header">
  <div>
    <div class="eyebrow">Bilan commercial ¬∑ √âquipe Famillys</div>
    <h1>Suivi des ventes <em style="font-style:italic;font-size:22px;color:var(--muted)">"Contrat"</em><br><span>2022 ‚Äì 2023 ‚Äì 2024 ‚Äì 2025 ‚Äì 2026</span></h1>
    <div class="print-date" id="printDate"></div>
  </div>
</div>

<div class="tabs-wrap no-print">
  <div class="tabs">
    <button class="tab" onclick="show('2022')">2022</button>
    <button class="tab" onclick="show('2023')">2023</button>
    <button class="tab" onclick="show('2024')">2024</button>
    <button class="tab" onclick="show('2025')">2025</button>
    <button class="tab" onclick="show('2026')">2026</button>
    <button class="tab tw" onclick="show('2026w')">üìÖ Semaines 2026</button>
  </div>
  <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimer / PDF</button>
</div>

<div class="kpis" id="kpis"></div>

<!-- VUE MENSUELLE -->
<div id="vm">
  <div class="charts-grid">
    <div class="chart-card"><h3>Contrats sign√©s / mois</h3><div class="chart-wrap"><canvas id="cC"></canvas></div></div>
    <div class="chart-card"><h3>CA mensuel &amp; Cumul (‚Ç¨)</h3><div class="chart-wrap"><canvas id="cA"></canvas></div></div>
  </div>
  <div class="table-card">
    <div class="table-head-bar"><span id="tTitle"></span><span class="sub" id="tSub"></span></div>
    <table>
      <thead><tr><th>Mois</th><th class="c">Contrats</th><th class="r">CA mensuel</th><th class="r">CA cumul√©</th><th class="c">R√©partition</th></tr></thead>
      <tbody id="tBody"></tbody>
      <tfoot id="tFoot"></tfoot>
    </table>
  </div>
</div>

<!-- VUE HEBDO -->
<div id="vw" style="display:none">
  <div class="charts-grid">
    <div class="chart-card"><h3>Contrats / semaine</h3><div class="chart-wrap"><canvas id="cWC"></canvas></div></div>
    <div class="chart-card"><h3>CA hebdo &amp; Cumul (‚Ç¨)</h3><div class="chart-wrap"><canvas id="cWA"></canvas></div></div>
  </div>
  <div class="table-card">
    <div class="table-head-bar"><span>Suivi hebdomadaire ¬∑ 2026</span><span class="sub" id="wSub"></span></div>
    <table>
      <thead><tr>
        <th>Semaine</th><th>P√©riode</th><th class="c">Contrats</th>
        <th class="c">vs pr√©c.</th><th class="r">Commission sem.</th><th class="r">Commission cumul</th><th class="c">Moy/jour</th>
      </tr></thead>
      <tbody id="wBody"></tbody>
      <tfoot id="wFoot"></tfoot>
    </table>
  </div>
</div>

<!-- COMPARAISON -->
<div class="chart-full" id="compareBlock">
  <h3>Comparaison toutes ann√©es ‚Äî Contrats par mois</h3>
  <div class="chart-wrap" style="height:230px"><canvas id="cComp"></canvas></div>
  <div class="legend" id="leg"></div>
</div>

<div class="note">
  <strong>Note :</strong> Tarifs enregistr√©s dans le fichier source ‚Äî
  <span class="tag t349">349 ‚Ç¨</span> standard,
  <span class="tag t99">99 ‚Ç¨</span> et <span class="tag t79">79 ‚Ç¨</span> promotionnels (mars‚Äìao√ªt 2025).
  2026 couvre S01‚ÜíS09 (jusqu'au 28 f√©v.). Mis √† jour le <span id="nDate"></span>.
</div>

<script>
const M = ["Jan","F√©v","Mar","Avr","Mai","Jun","Jul","Ao√ª","Sep","Oct","Nov","D√©c"];
const fmt = v => v.toLocaleString('fr-FR');
const fK = v => v>=1000?(v/1000).toFixed(1)+'k':v;

const MD = {
  2022:[{m:1,n:31,p3:31,p9:0,p7:0},{m:2,n:37,p3:37,p9:0,p7:0},{m:3,n:44,p3:44,p9:0,p7:0},{m:4,n:36,p3:36,p9:0,p7:0},{m:5,n:30,p3:30,p9:0,p7:0},{m:6,n:31,p3:31,p9:0,p7:0},{m:7,n:21,p3:21,p9:0,p7:0},{m:8,n:42,p3:42,p9:0,p7:0},{m:9,n:33,p3:33,p9:0,p7:0},{m:10,n:26,p3:26,p9:0,p7:0},{m:11,n:23,p3:23,p9:0,p7:0},{m:12,n:13,p3:13,p9:0,p7:0}],
  2023:[{m:1,n:20,p3:20,p9:0,p7:0},{m:2,n:34,p3:34,p9:0,p7:0},{m:3,n:33,p3:33,p9:0,p7:0},{m:4,n:17,p3:17,p9:0,p7:0},{m:5,n:40,p3:40,p9:0,p7:0},{m:6,n:41,p3:41,p9:0,p7:0},{m:7,n:33,p3:33,p9:0,p7:0},{m:8,n:28,p3:28,p9:0,p7:0},{m:9,n:40,p3:40,p9:0,p7:0},{m:10,n:44,p3:44,p9:0,p7:0},{m:11,n:48,p3:48,p9:0,p7:0},{m:12,n:32,p3:32,p9:0,p7:0}],
  2024:[{m:1,n:33,p3:33,p9:0,p7:0},{m:2,n:43,p3:43,p9:0,p7:0},{m:3,n:55,p3:55,p9:0,p7:0},{m:4,n:38,p3:38,p9:0,p7:0},{m:5,n:42,p3:42,p9:0,p7:0},{m:6,n:33,p3:33,p9:0,p7:0},{m:7,n:60,p3:60,p9:0,p7:0},{m:8,n:51,p3:51,p9:0,p7:0},{m:9,n:45,p3:45,p9:0,p7:0},{m:10,n:35,p3:35,p9:0,p7:0},{m:11,n:42,p3:42,p9:0,p7:0},{m:12,n:53,p3:53,p9:0,p7:0}],
  2025:[{m:1,n:49,p3:49,p9:0,p7:0},{m:2,n:30,p3:30,p9:0,p7:0},{m:3,n:55,p3:28,p9:0,p7:27},{m:4,n:55,p3:18,p9:0,p7:37},{m:5,n:37,p3:13,p9:6,p7:18},{m:6,n:30,p3:23,p9:7,p7:0},{m:7,n:33,p3:32,p9:1,p7:0},{m:8,n:19,p3:14,p9:5,p7:0},{m:9,n:38,p3:38,p9:0,p7:0},{m:10,n:23,p3:23,p9:0,p7:0},{m:11,n:23,p3:23,p9:0,p7:0},{m:12,n:23,p3:23,p9:0,p7:0}],
  2026:[{m:1,n:34,p3:34,p9:0,p7:0},{m:2,n:37,p3:37,p9:0,p7:0}],
};

const WD = [
  {w:'S01',period:'29/12‚Üí04/01',n:2, ca:698},
  {w:'S02',period:'05/01‚Üí11/01',n:10,ca:3490},
  {w:'S03',period:'12/01‚Üí18/01',n:8, ca:2792},
  {w:'S04',period:'19/01‚Üí25/01',n:10,ca:3490},
  {w:'S05',period:'26/01‚Üí01/02',n:4, ca:1396},
  {w:'S06',period:'02/02‚Üí08/02',n:12,ca:4188},
  {w:'S07',period:'09/02‚Üí15/02',n:11,ca:3839},
  {w:'S08',period:'16/02‚Üí22/02',n:5, ca:1745},
  {w:'S09',period:'23/02‚Üí28/02',n:9, ca:3141},
];

const COLORS = {2022:'#d4a853',2023:'#8b5cf6',2024:'#c8a96e',2025:'#2c7a50',2026:'#2563eb'};
const ca = d => d.p3*349+(d.p9||0)*99+(d.p7||0)*79;

function buildM(y){ let c=0; return MD[y].map(d=>({...d,ca:ca(d),cumul:c+=ca(d),label:M[d.m-1]})); }
function buildW(){ let c=0; return WD.map((d,i)=>({...d,cumul:c+=d.ca,diff:i>0?d.n-WD[i-1].n:null})); }

const BO = {
  responsive:true,maintainAspectRatio:false,
  plugins:{legend:{display:false},tooltip:{backgroundColor:'#fffdf8',titleColor:'#8b7355',bodyColor:'#2c1a0e',borderColor:'#e8dfc8',borderWidth:1}},
  scales:{x:{grid:{display:false},ticks:{color:'#8b7355',font:{size:11}},border:{display:false}},y:{grid:{color:'#f0e8d8'},ticks:{color:'#8b7355',font:{size:11}},border:{display:false}}}
};

let cC,cA,cWC,cWA,cComp;

function kpi(items){ document.getElementById('kpis').innerHTML=items.map(k=>`<div class="kpi" style="border-left:4px solid ${k.c}"><div class="kpi-label">${k.l}</div><div class="kpi-value" style="color:${k.c}">${k.v}</div><div class="kpi-sub">${k.s}</div></div>`).join(''); }

function show(yr){
  document.querySelectorAll('.tab').forEach(t=>{
    const match = t.textContent.includes('Semaines') ? yr==='2026w' : t.textContent==yr;
    t.classList.toggle('active',match);
  });
  const isW = yr==='2026w';
  document.getElementById('vm').style.display = isW?'none':'block';
  document.getElementById('vw').style.display = isW?'block':'none';
  isW ? renderWeekly() : renderMonthly(+yr);
}

function renderMonthly(y){
  const data = buildM(y);
  const tN=data.reduce((s,d)=>s+d.n,0), tC=data.reduce((s,d)=>s+d.ca,0);
  const col = COLORS[y]||'#c8a96e';

  kpi([
    {l:'Contrats sign√©s',v:tN,s:y===2026?'jan‚Äìf√©v':'12 mois',c:col},
    {l:'CA total',v:fmt(tC)+' ‚Ç¨',s:"chiffre d'affaires",c:'#1a5c3a'},
    {l:'Moy. mensuelle',v:Math.round(tN/data.length)+' contrats',s:'par mois',c:'#5b21b6'},
    {l:'CA moy/contrat',v:Math.round(tC/tN)+' ‚Ç¨',s:'panier moyen',c:'#9d174d'},
  ]);

  document.getElementById('tTitle').textContent=`Bilan mensuel ¬∑ ${y}`;
  document.getElementById('tSub').textContent=`${tN} contrats ¬∑ ${fmt(tC)} ‚Ç¨`;
  document.getElementById('tBody').innerHTML=data.map(d=>`<tr>
    <td>${d.label}</td><td class="c"><span class="badge">${d.n}</span></td>
    <td class="r" style="font-weight:600;color:var(--green)">${fmt(d.ca)} ‚Ç¨</td>
    <td class="r" style="color:#5a3e2b">${fmt(d.cumul)} ‚Ç¨</td>
    <td class="c">${[d.p7>0?`<span class="tag t79">${d.p7}√ó79‚Ç¨</span>`:'',d.p9>0?`<span class="tag t99">${d.p9}√ó99‚Ç¨</span>`:'',d.p3>0?`<span class="tag t349">${d.p3}√ó349‚Ç¨</span>`:''].join('')}</td>
  </tr>`).join('');
  document.getElementById('tFoot').innerHTML=`<tr><td>TOTAL</td><td class="c"><span class="badge">${tN}</span></td><td class="r" style="color:var(--green);font-size:14px">${fmt(tC)} ‚Ç¨</td><td class="r" style="font-size:14px">${fmt(tC)} ‚Ç¨</td><td></td></tr>`;

  if(cC)cC.destroy();
  cC=new Chart(document.getElementById('cC'),{
    type:'bar',
    data:{labels:data.map(d=>d.label),datasets:[{data:data.map(d=>d.n),backgroundColor:col,borderRadius:5,label:'Contrats'}]},
    options:{...BO,plugins:{...BO.plugins,tooltip:{...BO.plugins.tooltip,callbacks:{label:ctx=>` ${ctx.raw} contrats`}}}}
  });

  if(cA)cA.destroy();
  cA=new Chart(document.getElementById('cA'),{
    type:'bar',
    data:{labels:data.map(d=>d.label),datasets:[
      {data:data.map(d=>d.ca),  backgroundColor:col+'99', borderRadius:5, label:'CA mensuel'},
      {data:data.map(d=>d.cumul), backgroundColor:col+'33', borderRadius:5, label:'CA cumul√©', stack:'cumul'}
    ]},
    options:{...BO,
      plugins:{...BO.plugins,legend:{display:true,labels:{color:'#8b7355',font:{size:11},boxWidth:12}},tooltip:{...BO.plugins.tooltip,callbacks:{label:ctx=>` ${fmt(ctx.raw)} ‚Ç¨`}}},
      scales:{x:BO.scales.x,y:{...BO.scales.y,ticks:{...BO.scales.y.ticks,callback:v=>fK(v)+'‚Ç¨'}}}
    }
  });
}

// Commission : 7.5% √ó (349 TTC / 1.2) = 21.81 ‚Ç¨ par contrat sign√©, quel que soit le tarif pratiqu√©
// Commission : 21.81 ‚Ç¨ uniquement sur les contrats √† 349‚Ç¨ (79‚Ç¨ et 99‚Ç¨ exclus - tarifs promo arr√™t√©s mi-2025)
const COMM_UNIT = Math.round(349 / 1.2 * 0.075 * 100) / 100; // 21.81 ‚Ç¨
const commN = n => +(n * COMM_UNIT).toFixed(2); // pour la vue hebdo (tout √† 349‚Ç¨ en 2026)
const commLine = d => +((d.p3||0) * COMM_UNIT).toFixed(2); // pour la vue mensuelle : p3 = contrats 349‚Ç¨ uniquement

function renderWeekly(){
  const data = buildW();
  const tN = data.reduce((s,d)=>s+d.n,0);
  const tComm = commN(tN);
  const last = data[data.length-1];

  kpi([
    {l:'Contrats cumul√©s',   v:tN,                          s:`${data.length} semaines`, c:'#2563eb'},
    {l:'Commission cumul√©e', v:tComm.toFixed(2)+' ‚Ç¨',       s:'7,5% du HT (21,81 ‚Ç¨/contrat)', c:'#b45309'},
    {l:'Derni√®re semaine',   v:last.n+' contrats',           s:last.period,               c:'#d97706'},
    {l:'Moy. hebdomadaire',  v:Math.round(tN/data.length)+' contrats', s:'par semaine',  c:'#7c3aed'},
  ]);

  document.getElementById('wSub').textContent=`${tN} contrats ¬∑ commission cumul√©e : ${tComm.toFixed(2)} ‚Ç¨`;

  // Tableau exhaustif (toutes semaines) avec commission
  let cumulComm = 0;
  document.getElementById('wBody').innerHTML=data.map((d,i)=>{
    const tr = d.diff===null ? '' : d.diff>0 ? `<span class="trend-up">‚ñ≤ +${d.diff}</span>` : d.diff<0 ? `<span class="trend-down">‚ñº ${d.diff}</span>` : `<span class="trend-eq">= 0</span>`;
    const cm = commN(d.n);
    cumulComm = +(cumulComm + cm).toFixed(2);
    return `<tr class="${i===data.length-1?'week-last':''}">
      <td><strong>${d.w}</strong></td>
      <td style="color:var(--muted);font-size:12px">${d.period}</td>
      <td class="c"><span class="badge">${d.n}</span></td>
      <td class="c">${tr}</td>
      <td class="r" style="font-weight:600;color:#b45309">${cm.toFixed(2)} ‚Ç¨</td>
      <td class="r" style="color:#92400e">${cumulComm.toFixed(2)} ‚Ç¨</td>
      <td class="c" style="color:var(--muted)">${(d.n/5).toFixed(1)}/j</td>
    </tr>`;
  }).join('');
  document.getElementById('wFoot').innerHTML=`<tr>
    <td colspan="2">TOTAL ¬∑ ${data.length} sem.</td>
    <td class="c"><span class="badge">${tN}</span></td>
    <td></td>
    <td class="r" style="color:#b45309;font-size:14px;font-weight:700">${tComm.toFixed(2)} ‚Ç¨</td>
    <td class="r" style="color:#92400e;font-size:14px;font-weight:700">${tComm.toFixed(2)} ‚Ç¨</td>
    <td class="c" style="color:var(--muted)">${(tN/(data.length*5)).toFixed(1)}/j</td>
  </tr>`;

  // Graphiques : 5 derni√®res semaines uniquement
  const last5 = data.slice(-5);

  if(cWC)cWC.destroy();
  cWC=new Chart(document.getElementById('cWC'),{
    type:'bar',
    data:{labels:last5.map(d=>d.w), datasets:[{data:last5.map(d=>d.n), backgroundColor:'#2563eb', borderRadius:5, label:'Contrats'}]},
    options:{...BO, plugins:{...BO.plugins, tooltip:{...BO.plugins.tooltip, callbacks:{label:ctx=>` ${ctx.raw} contrats`}}}}
  });

  if(cWA)cWA.destroy();
  cWA=new Chart(document.getElementById('cWA'),{
    type:'bar',
    data:{labels:last5.map(d=>d.w), datasets:[
      {data:last5.map(d=>commN(d.n)), backgroundColor:'#fbbf24', borderRadius:5, label:'Commission sem.'},
      {data:last5.map((_,i)=>commN(data.slice(0,data.indexOf(last5[i])+1).reduce((s,x)=>s+x.n,0))), backgroundColor:'#f59e0b55', borderRadius:5, label:'Cumul comm.'}
    ]},
    options:{...BO,
      plugins:{...BO.plugins, legend:{display:true,labels:{color:'#8b7355',font:{size:11},boxWidth:12}}, tooltip:{...BO.plugins.tooltip,callbacks:{label:ctx=>` ${Number(ctx.raw).toFixed(2)} ‚Ç¨`}}},
      scales:{x:BO.scales.x, y:{...BO.scales.y, ticks:{...BO.scales.y.ticks,callback:v=>v+'‚Ç¨'}}}
    }
  });
}

function buildCompare(activeYear){
  const y = activeYear==='2026w' ? 2026 : +activeYear;
  const years = [y-2, y-1, y].filter(x=>MD[x]);
  if(cComp)cComp.destroy();
  cComp=new Chart(document.getElementById('cComp'),{
    type:'bar',
    data:{labels:M, datasets:years.map(yr=>({
      label:''+yr,
      data:M.map((_,i)=>{const d=MD[yr].find(x=>x.m===i+1);return d?d.n:null;}),
      backgroundColor:COLORS[yr]+'bb', borderRadius:4, borderSkipped:false
    }))},
    options:{...BO,
      plugins:{...BO.plugins, legend:{display:false}, tooltip:{...BO.plugins.tooltip,callbacks:{label:ctx=>` ${ctx.dataset.label} : ${ctx.raw} contrats`}}},
      scales:{x:{...BO.scales.x}, y:{...BO.scales.y}}
    }
  });
  document.getElementById('leg').innerHTML=years.map(yr=>{
    const d=MD[yr], tN=d.reduce((s,x)=>s+x.n,0), tC=d.reduce((s,x)=>s+ca(x),0);
    return `<div class="legend-item"><div class="ldot" style="background:${COLORS[yr]}"></div><strong style="color:var(--dark)">${yr}</strong><span>${tN} contrats ¬∑ ${fmt(tC)} ‚Ç¨${yr===2026?' (jan‚Äìf√©v)':''}</span></div>`;
  }).join('');
}

// Surcharge show() pour appeler buildCompare avec l'ann√©e active
const _show = show;
function show(yr){
  document.querySelectorAll('.tab').forEach(t=>{
    const match = t.textContent.includes('Semaines') ? yr==='2026w' : t.textContent==yr;
    t.classList.toggle('active',match);
  });
  const isW = yr==='2026w';
  document.getElementById('vm').style.display = isW?'none':'block';
  document.getElementById('vw').style.display = isW?'block':'none';
  if(isW){ renderWeekly(); } else { renderMonthly(+yr); }
  document.getElementById('compareBlock').style.display = isW ? 'none' : 'block';
  if(!isW) buildCompare(yr);
}

const ds = new Date().toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'});
document.getElementById('printDate').textContent=`Mis √† jour le ${ds}`;
document.getElementById('nDate').textContent=ds;

show('2026w');
</script>
</body>
</html>
